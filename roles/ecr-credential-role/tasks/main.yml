---
# 1. التأكد من تثبيت AWS CLI على جميع العقد (مهم لسحب التوكن)
- name: Ensure awscli is installed (Needed for ECR Token generation) 
  ansible.builtin.apt:
    name: awscli
    state: present
  when: ansible_os_family == 'Debian'

# 2. إنشاء Script تحديث الـ Secret على الماستر Node فقط
- name: Create ECR refresh script on Master Node
  ansible.builtin.copy:
    dest: /usr/local/bin/ecr-refresh.sh
    content: |
      #!/bin/bash
      
      # تأكد من متغيرات البيئة KUBECONFIG إذا لزم الأمر
      export KUBECONFIG=/etc/kubernetes/admin.conf
      
      # حدد معلومات ECR (استخدم القيم الثابتة للحساب والمنطقة)
      ECR_REGION="us-east-1"
      ECR_REGISTRY="772683617793.dkr.ecr.us-east-1.amazonaws.com"
      SECRET_NAME="ecr-creds"
      SECRET_NAMESPACE="default"
      
      # استخدام AWS CLI (الذي يستخدم IAM Role) لجلب رمز الدخول المؤقت
      TOKEN=$(/usr/bin/aws ecr get-login-password --region $ECR_REGION)
      
      # إنشاء أو تحديث الـ Secret (حذف القديم وإضافة الجديد)
      kubectl delete secret $SECRET_NAME --ignore-not-found -n $SECRET_NAMESPACE
      kubectl create secret docker-registry $SECRET_NAME \
        --docker-server=$ECR_REGISTRY \
        --docker-username=AWS \
        --docker-password="${TOKEN}" \
        --namespace=$SECRET_NAMESPACE
    mode: '0755'
  # الشرط الصحيح لضمان التنفيذ على الماستر فقط
  when: inventory_hostname == 'kube-master1'

# يتم وضع هذه المهمة مباشرة بعد مهمة "Create ECR refresh script on Master Node"
- name: Execute ECR refresh script immediately after creation (Run Once)
  ansible.builtin.command: /usr/local/bin/ecr-refresh.sh
  register: ecr_refresh_immediate_status
  changed_when: ecr_refresh_immediate_status.rc == 0
  become: yes
  when: inventory_hostname == 'kube-master1'
# 3. جدولة التحديث باستخدام Cron
# مهمة Cron المعدلة (كل ساعة)
- name: Schedule ECR credential refresh via Cron to run every hour
  ansible.builtin.cron:
    name: "ECR credential refresh"
    minute: "0" # يتم التنفيذ في بداية كل ساعة (00:00, 01:00, 02:00, وهكذا)
    hour: "*"   # تم التعديل ليتم التنفيذ كل ساعة
    job: "/usr/local/bin/ecr-refresh.sh > /dev/null 2>&1"
    user: root
  when: inventory_hostname == 'kube-master1'
